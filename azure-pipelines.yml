# Docker
# Build and push an image to Azure Container Registry
# https://docs.microsoft.com/azure/devops/pipelines/languages/docker

trigger:
- main
- qa

resources:
- repo: self

variables:
  # Container registry service connection established during pipeline creation
  - name: dockerRegistryServiceConnection:
    value: 'cb295ce7-2beb-436a-8d5d-4be6579b4b3b'
  - name: imageRepository
    value: 'react-cv'
  - name: containerRegistry
    value: 'nicoandra.azurecr.io'
  - name: dockerfilePath
    value: '$(Build.SourcesDirectory)/Dockerfile'
  - name: tag
    value: '$(Build.BuildId)'
  - name: tagQaOrLatest
    ${{ if eq(variables['Build.SourceBranchName'], 'main') }}:
      value: latest
    ${{ if eq(variables['Build.SourceBranchName'], 'qa') }}:
      value: qa
  - name: tagQaOrLatest
    ${{ if eq(variables['Build.SourceBranchName'], 'main') }}:
      value: latest
    ${{ if eq(variables['Build.SourceBranchName'], 'qa') }}:
      value: qa

  # Agent VM image name
  vmImageName: 'ubuntu-latest'

stages:
- stage: Build
  displayName: Build and push stage
  jobs:  
  - job: Build
    displayName: Build
    pool:
      vmImage: $(vmImageName)
    steps:
    - task: Docker@2
      displayName: Build and push an image to container registry
      inputs:
        command: buildAndPush
        repository: $(imageRepository)
        dockerfile: $(dockerfilePath)
        containerRegistry: $(dockerRegistryServiceConnection)
        tags: |
          $(tag)
          $(tagQaOrLatest)
- stage: Deploy
  displayName: Deploy
  - task: AzureRmWebAppDeployment@4
    condition: eq(variables.tagQaOrLatest, "latest")
    inputs:
      ConnectionType: 'AzureRM'
      azureSubscription: 'Free Trial(1)(2796664e-e9d7-4d96-a30d-36aba0e530b2)'
      appType: 'webAppContainer'
      WebAppName: 'nicoandra'
      DockerNamespace: 'nicoandra.azurecr.io'
      DockerRepository: 'react-cv'
      DockerImageTag: 'latest'
  - task: AzureRmWebAppDeployment@4
    condition: eq(variables.tagQaOrLatest, "qa")
    inputs:
      ConnectionType: 'AzureRM'
      azureSubscription: 'Free Trial(1)(2796664e-e9d7-4d96-a30d-36aba0e530b2)'
      appType: 'webAppContainer'
      WebAppName: 'nicoandra-qa'
      DockerNamespace: 'nicoandra.azurecr.io'
      DockerRepository: 'react-cv'
      DockerImageTag: 'latest'
  